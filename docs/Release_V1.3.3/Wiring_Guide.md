# 接線指南 (Wiring Guide)

**警告：在進行任何焊接或連接之前，請確保所有設備都已斷電！** 
建議使用萬用板或PCB進行最終的電路搭建，以保證連接的可靠性和安全性。

本指南基於程式碼中的預設引腳定義。如果您修改了引腳，請對應更改接線。

部分引腳定義可能需依您的ESP32型號或程式碼設定進行調整。以下以"*"標示

---

### 1. 電源分區與接地策略

本專案採用「二次隔離」電源架構，將系統分為「啟動電源部分」和「控制部分」。

*   **12V 啟動電源**：由主電源降壓而來，用於供應車端VP啟動充電及二次降壓給控制電路使用。
*   **5V 控制電源**：由 12V 經過 5V DC-DC轉換而來，專門為ESP32、CAN模組、OLED等核心控制電路供電。 
*   **公共地 (GND)**：所有模組的GND最終需連接在一起，形成共同參考電位。建議採用星形接地以獲最佳效果。

---

### 2. 模組連接詳解

#### 主控制器 (ESP32 DevKitC)
*   **電源**:
    *   `VIN`: 隔離型DC-DC模組的 **+5V** 輸出。
    *   `GND`: **公共地 (GND)**。

#### CAN Bus 模組 (MCP2515)
*   **電源**:
    *   `VCC`: **+5V**。
    *   `GND`: **公共地 (GND)**。
*   **SPI 通訊**:
    *   `CS`: **GPIO 5**。*
    *   `SO` (MISO): **GPIO 19**。
    *   `SI` (MOSI): **GPIO 23**。
    *   `SCK`: **GPIO 18**。
*   **中斷信號**:
    *   `INT`: **GPIO 35**。*
*   **CAN接口**:
    *   `CAN-H`：**充電槍CAN-H**。
    *   `CAN-L`：**充電槍CAN-L**。
    *   **連接至車輛時須確保沒有短路及功能正常，否則無法正常運作甚至燒BMS!!!**

#### ADS1115
*   **電源**:
    *   `VDD`：**+5V**。
    *   `GND`: **公共地 (GND)**。
*   **IIC**:
    *   `SCL`：**GPIO 22**。
    *   `SDA`：**GPIO 21**。
*   **地址設定**:
    *   `ADDR`: **公共地 (GND)**，將I2C地址設為 `0x48`。
*   **差分測量A0-A1(主電源)**:
    1.  **分壓電路**:
        *   將 **348kΩ** 電阻 (R1) 和 **12kΩ** 電阻 (R2) **串聯**。
        *   串聯電路的頂端連接到主電源的 **正極 (+)**。
        *   串聯電路的底端連接到**公共地 (GND)**。

    2.  **差分信號連接**:
        *   將 **R1和R2的連接點** (即分壓點) 連接到 ADS1115 的 `A0` 引腳。
        *   將 **R2的底端** 連接到 ADS1115 的 `A1` 引腳。

    3.  **濾波電路**:
        *   在 `A0` 和 `A1` 之間，並聯一個 **1uF 的陶瓷電容**。
*   **差分測量A2-A3(CP)**:
    1.  **分壓電路**:
        *   將 **150kΩ** 電阻 (R1) 和 **51Ω** 電阻 (R2) **串聯**。
        *   串聯電路的頂端連接到 **CP**。
        *   串聯電路的底端連接到 **公共地 (GND)**。

    2.  **差分信號連接**:
        *   將 **R1和R2的連接點** (即分壓點) 連接到 ADS1115 的 `A2` 引腳。
        *   將 **R2的底端** 連接到 ADS1115 的 `A3` 引腳。

    3.  **濾波電路**:
        *   在 `A2` 和 `A3` 之間，並聯一個 **1uF 的陶瓷電容**。
---

### 3. 使用者介面與外設

#### 按鈕與顯示
*   **通用接法**: 所有按鈕的一端都連接到**公共地 (GND)**。
*   **所有LED的負極**（短腳）都通過一個限流電阻（150Ω）連接到**公共地 (GND)**。
*   **按鈕連接**:
    *   Start Button: **GPIO 32**。*
    *   Stop Button: **GPIO 33**。*
    *   Emergency Button: **GPIO 25**。*
    *   Setting Button: **GPIO 4**。*
*   **LED 連接**:
    *   橘色待機LED (正極): **GPIO 14**。*
    *   綠色充電LED (正極): **GPIO 12**。*
    *   紅色錯誤LED (正極): **GPIO 13**。*
*   **OLED 連接**：
    *   `VCC`：**+5V**。
    *   `GND`：**公共地 (GND)**。
    *   `SCL`：**GPIO 22**。
    *   `SDA`：**GPIO 21**。

#### 繼電器與其他
*   **VP 繼電器**:
    *   `+`：**+5V**。
    *   `-`：**公共地 (GND)**。
    *   `S`：**GPIO 15**。*
    *   `COM`：**+12V**。
    *   `NO`：**充電槍VP**。
*   **充電槍剩餘接腳**：
    *    `GD`：**公共地 (GND)**。
    *    `DC+`：**主電源+**。
    *    `DC-`：**主電源-**。
*   **12V降壓電源**：
    *    `Vin+`：**主電源+**。
    *    `Vin-`：**主電源-**。
    *    `12V+`：VP繼電器 的 **COM**。
    *    `12V-`：**公共地 (GND)**。
*   **5V降壓電源**
    *    `Vin+`：**12V+** 或 VP繼電器 的 **COM**。
    *    `Vin-`：**12V-** 或 **公共地 (GND)**。
    *    `5V+`：ESP32 的 **VIN**。
    *    `5V-`：**公共地 (GND)**。
