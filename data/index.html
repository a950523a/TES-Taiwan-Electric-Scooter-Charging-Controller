<!DOCTYPE html>
<html>
<head>
    <title>TES Charger Control</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 8px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: auto; }
        .card { background-color: white; box-shadow: 0 2px 4px 0 rgba(0,0,0,0.1); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        h1, h2, h3 { color: #333; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; }
        .data-item label { color: #666; }
        .data-item .value { font-size: 1.8em; font-weight: bold; color: #000; }
        .button-group { display: flex; gap: 10px; margin-top: 16px; }
        .btn { padding: 12px 24px; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; }
        .btn-start { background-color: #4CAF50; color: white; }
        .btn-stop { background-color: #F44336; color: white; }
        .btn-update { background-color: #008CBA; color: white; }
        .btn-update:disabled { background-color: #cccccc; cursor: not-allowed; }
        .progress-bar { width: 100%; background-color: #f1f1f1; border-radius: 5px; margin-top: 10px; }
        .progress-bar-inner { width: 0%; height: 20px; background-color: #4CAF50; border-radius: 5px; text-align: center; line-height: 20px; color: white; transition: width 0.5s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TES Charger Status</h1>
        <div class="card">
            <h2>Live Data</h2>
            <div class="data-grid">
                <div class="data-item"><label>Voltage</label><div><span id="voltage" class="value">--</span> V</div></div>
                <div class="data-item"><label>Current</label><div><span id="current" class="value">--</span> A</div></div>
                <div class="data-item"><label>SOC</label><div><span id="soc" class="value">--</span> %</div></div>
                <div class="data-item"><label>Time Left</label><div><span id="time" class="value">--:--</span></div></div>
            </div>
        </div>
        <div class="card">
            <h2>Controls & Settings</h2>
            <div class="data-grid">
                <div class="data-item"><label>Target SOC</label><div><span id="target_soc">--</span> %</div></div>
                <div class="data-item"><label>Max Current</label><div><span id="max_current">--</span> A</div></div>
            </div>
            <div class="button-group">
                <button class="btn btn-start" onclick="sendAction('/start_charge')">START</button>
                <button class="btn btn-stop" onclick="sendAction('/stop_charge')">STOP</button>
            </div>
        </div>
        
        <!-- [修改] About & OTA 區塊 -->
        <div class="card">
            <h2>About & Firmware Update</h2>
            <p><strong>Current Firmware:</strong> <span id="current_fw">--</span></p>
            <p><strong>Current Web UI:</strong> <span id="current_fs">--</span></p>
            <p><strong>IP Address:</strong> <span id="ip_address">--</span></p>
            <p><strong>Copyright (c) 2025 Chris Huang</strong></p>
            
            <h3>Online Update (Requires Internet)</h3>
            <div class="button-group">
                <button class="btn btn-update" onclick="sendAction('/ota_check')">Check for Updates</button>
                <button id="btn_update_start" class="btn btn-update" onclick="sendAction('/ota_start')" disabled>Start Full Update</button>
            </div>
            <p><strong>Status:</strong> <span id="ota_status">Idle</span></p>
            <div class="progress-bar">
                <div id="ota_progress" class="progress-bar-inner">0%</div>
            </div>

            <h3>Manual Update (Offline)</h3>
            <!-- [修改] 韌體手動上傳 -->
            <h4>Upload Firmware (.bin)</h4>
            <form id="upload_fw_form" method="POST" action="/update_fw" enctype="multipart/form-data">
                <input type="file" name="firmware_update">
                <input type="submit" value="Upload Firmware">
            </form>

            <!-- [新增] 檔案系統手動上傳 -->
            <h4>Upload Web UI (.bin)</h4>
            <form id="upload_fs_form" method="POST" action="/update_fs" enctype="multipart/form-data">
                <input type="file" name="filesystem_update">
                <input type="submit" value="Upload Web UI">
            </form>
        </div>
    </div>


    <script>
        function sendAction(path) {
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", path, true);
            xhttp.send();
        }

        function updateStatus() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    var data = JSON.parse(this.responseText);
                    // 更新 Live Data
                    document.getElementById("voltage").innerHTML = data.voltage.toFixed(1);
                    document.getElementById("current").innerHTML = data.current.toFixed(1);
                    document.getElementById("soc").innerHTML = data.soc;
                    document.getElementById("time").innerHTML = data.time_formatted;
                    document.getElementById("target_soc").innerHTML = data.target_soc;
                    document.getElementById("max_current").innerHTML = data.max_current.toFixed(1);
                    
                    // 更新 About & OTA
                    document.getElementById("current_fw").innerHTML = data.current_fw_version;
                    document.getElementById("current_fs").innerHTML = data.filesystem_version;
                    document.getElementById("ip_address").innerHTML = data.ip_address;
                    document.getElementById("ota_status").innerHTML = data.ota_status_message;
                    
                    var btnUpdate = document.getElementById("btn_update_start");
                    if (data.update_available) {
                        btnUpdate.disabled = false;
                        btnUpdate.innerHTML = "Update to " + data.latest_fw_version;
                    } else {
                        btnUpdate.disabled = true;
                        btnUpdate.innerHTML = "Start Full Update";
                    }
                    
                    var progressBar = document.getElementById("ota_progress");
                    progressBar.style.width = data.ota_progress + "%";
                    progressBar.innerHTML = data.ota_progress + "%";
                }
            };
            xhttp.open("GET", "/status.json", true);
            xhttp.send();
        }

        // 處理手動上傳表單
        document.getElementById('upload_fw_form').addEventListener('submit', function(e) {
            e.preventDefault();
            var form = e.target;
            var data = new FormData(form);
            var xhr = new XMLHttpRequest();
            xhr.open(form.method, form.action, true);
            xhr.onload = function(e) {
                if (xhr.status === 200) {
                    alert('Firmware upload successful! The device will now reboot.');
                    // 延遲一小段時間，確保伺服器有時間處理重啟
                    setTimeout(function(){ window.location.reload(); }, 3000);
                } else {
                    alert('Firmware upload failed. Please try again.');
                }
            };
            xhr.send(data);
        });

        // [新增] 處理手動上傳檔案系統表單
        document.getElementById('upload_fs_form').addEventListener('submit', function(e) {
            e.preventDefault();
            var form = e.target;
            var data = new FormData(form);
            var xhr = new XMLHttpRequest();
            xhr.open(form.method, form.action, true);
            xhr.onload = function(e) {
                if (xhr.status === 200) {
                    alert('Web UI upload successful! The device will now reboot.');
                    setTimeout(function(){ window.location.reload(); }, 3000);
                } else {
                    alert('Web UI upload failed. Please try again.');
                }
            };
            xhr.send(data);
        });

        window.onload = function() { updateStatus(); };
        setInterval(updateStatus, 2000);
    </script>
</body>
</html>