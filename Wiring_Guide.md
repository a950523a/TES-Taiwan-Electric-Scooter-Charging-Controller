# 接線指南 (Wiring Guide)

**警告：在進行任何焊接或連接之前，請確保所有設備都已斷電！** 
建議使用萬用板或PCB進行最終的電路搭建，以保證連接的可靠性和安全性。

本指南基於程式碼中的預設引腳定義。如果您修改了引腳，請對應更改接線。

部分引腳定義可能需依您的ESP32型號或程式碼設定進行調整。以下以"*"標示

---

### 1. 電源分區與接地策略

本專案採用「二次隔離」電源架構，將系統分為「啟動電源部分」和「控制部分」，以最大程度避免雜訊干擾。

*   **12V 啟動電源**：由主電源降壓而來，用於供應車端VP啟動充電及二次降壓給控制電路使用。
*   **5V 隔離控制電源**：由12V經過隔離型DC-DC轉換而來，專門為ESP32、CAN模組、OLED等核心控制電路供電。
*   **公共地 (GND)**：所有模組的GND最終需連接在一起，形成共同參考電位。建議採用星形接地以獲最佳效果。

---

### 2. 模組連接詳解

#### 主控制器 (ESP32 DevKitC)
*   **電源**:
    *   `VIN`: 隔離型DC-DC模組的 **+5V** 輸出。
    *   `GND`: **公共地 (GND)**。

#### CAN Bus 模組 (MCP2515)
*   **電源**:
    *   `VCC`: **+5V**。
    *   `GND`: **公共地 (GND)**。
*   **SPI 通訊**:
    *   `CS`: **GPIO 5**。*
    *   `SO` (MISO): **GPIO 19**。
    *   `SI` (MOSI): **GPIO 23**。
    *   `SCK`: **GPIO 18**。
*   **中斷信號**:
    *   `INT`: **GPIO 35**。*
*   **CAN接口**:
    *   `CAN-H`：**充電槍CAN-H**。
    *   `CAN-L`：**充電槍CAN-L**。

#### Modbus 電壓表 (5V TTL UART)
*   **電源**:
    *   `U+`：**主電源+**。
    *   `PW+`: **+5V**。
    *   `GND`: **公共地 (GND)**。
*   **UART 通訊 (需要電平轉換)**:
    *   模組的 `TX` (5V) -> 1KΩ電阻 -> ESP32 的 **GPIO 16 (RX2)** -> 2KΩ電阻 -> **公共地 (GND)**。
    *   模組的 `RX` (5V) <- **GPIO 17 (TX2)**。
    *   `GND`: **公共地 (GND)**。
   

#### CP 信號讀取電路
*   **分壓電阻**:
    *   **充電槍CP** 信號線 -> 150Ω電阻 -> **GPIO 34 (ADC)** -> 51Ω電阻 -> **公共地 (GND)**。

---

### 3. 使用者介面與外設

#### 按鈕與顯示
*   **通用接法**: 所有按鈕的一端都連接到**公共地 (GND)**。
*   **所有LED的負極**（短腳）都通過一個限流電阻（150Ω）連接到**公共地 (GND)**。
*   **按鈕連接**:
    *   Start Button: **GPIO 32**。*
    *   Stop Button: **GPIO 33**。*
    *   Emergency Button: **GPIO 25**。*
    *   Setting Button: **GPIO 4**。*
*   **LED 連接**:
    *   橘色待機LED (正極): **GPIO 14**。*
    *   綠色充電LED (正極): **GPIO 12**。*
    *   紅色錯誤LED (正極): **GPIO 13**。*
*   **OLED 連接**：
    *   `VCC`：**+5V**。
    *   `GND`：**公共地 (GND)**。
    *   `SCL`：**GPIO 22**。
    *   `SDA`：**GPIO 21**。

#### 繼電器與其他
*   **VP 繼電器**:
    *   `+`：**+5V**。
    *   `-`：**公共地 (GND)**。
    *   `S`：**GPIO 15**。*
    *   `COM`：**+12V**。
    *   `NO`：**充電槍VP**。
*   **充電槍剩餘接腳**：
    *    `GD`：**公共地 (GND)**。
    *    `DC+`：**主電源+**。
    *    `DC-`：**主電源-**。
*   **12V降壓電源**：
    *    `Vin+`：**主電源+**。
    *    `Vin-`：**主電源-**。
    *    `12V+`：VP繼電器 的 **COM**。
    *    `12V-`：**公共地 (GND)**。
*   **5V隔離降壓電源**
    *    `Vin+`：**12V+** 或 VP繼電器 的 **COM**。
    *    `Vin-`：**12V-** 或 **公共地 (GND)**。
    *    `5V+`：ESP32 的 **VIN**。
    *    `5V-`：**公共地 (GND)**。
